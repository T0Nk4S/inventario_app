rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Usuarios collection
    match /Usuarios/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isAdmin(request.auth.uid));
      // Permitimos que un usuario autenticado cree SU propio perfil (uid == userId).
      // Esto permite el flujo de registro/creaci√≥n de admin desde la app. Revisar y
      // endurecer esta regla tras el provisionamiento inicial si se desea.
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin(request.auth.uid));
      allow delete: if isAdmin(request.auth.uid);
    }

    // Proveedores: admin and authenticated users can read, admin can write
    match /Proveedores/{doc} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin(request.auth.uid);
    }

    // Productos: authenticated users can read, admin can write
    match /Productos/{doc} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin(request.auth.uid);
    }

    // Movimientos: authenticated users can create and read, admin can delete
    match /Movimientos/{doc} {
      allow read, create: if request.auth != null;
      allow delete: if isAdmin(request.auth.uid);
    }

    // Ventas: authenticated users can create and read, admin can delete
    match /Ventas/{doc} {
      allow read, create: if request.auth != null;
      allow delete: if isAdmin(request.auth.uid);
    }

    // Helper function
    function isAdmin(uid) {
      return uid != null && get(/databases/$(database)/documents/Usuarios/$(uid)).data.rol == 'admin';
    }
  }
}